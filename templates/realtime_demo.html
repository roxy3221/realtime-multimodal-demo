<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å¤šæ¨¡æ€åˆ†æDemo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            min-height: 100vh;
        }
        
        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .main-content {
            display: contents;
        }
        
        .video-section, .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        .controls {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #videoPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .face-box {
            position: absolute;
            border: 2px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }
        
        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-connected { background-color: #27ae60; }
        .status-disconnected { background-color: #e74c3c; }
        .status-processing { background-color: #f39c12; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex: 1;
        }
        
        .metric-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }
        
        .metric-title {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-subtitle {
            font-size: 0.8em;
            color: #7f8c8d;
        }
        
        .chart-container {
            height: 200px;
            margin: 15px 0;
        }
        
        .asr-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .asr-current {
            color: #f39c12;
            font-weight: bold;
        }
        
        .asr-final {
            color: #27ae60;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .settings-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #667eea;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å®æ—¶å¤šæ¨¡æ€åˆ†æç³»ç»Ÿ</h1>
            <p class="subtitle">è¯­éŸ³è¯†åˆ« + éŸµå¾‹åˆ†æ + é¢éƒ¨è¡¨æƒ…æ£€æµ‹</p>
        </div>
        
        <div class="video-section">
            <h3>è§†é¢‘é‡‡é›†ä¸é¢éƒ¨åˆ†æ</h3>
            <div class="video-container">
                <video id="videoPreview" autoplay muted></video>
                <canvas id="faceOverlay" class="face-overlay"></canvas>
                <div id="statusIndicator" class="status-indicator status-disconnected">æœªè¿æ¥</div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">å¤´éƒ¨å§¿æ€</div>
                    <div class="metric-value" id="headPose">0Â°, 0Â°</div>
                    <div class="metric-subtitle">åèˆªè§’, ä¿¯ä»°è§’</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">è¡¨æƒ…è¯†åˆ«</div>
                    <div class="metric-value" id="expression">ä¸­æ€§</div>
                    <div class="metric-subtitle">ç½®ä¿¡åº¦: <span id="expressionConf">0%</span></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">çœ¼éƒ¨çŠ¶æ€</div>
                    <div class="metric-value" id="eyeState">æ­£å¸¸</div>
                    <div class="metric-subtitle">EAR: <span id="earValue">0.30</span></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">é¢éƒ¨ç¨³å®šæ€§</div>
                    <div class="metric-value" id="stability">ç¨³å®š</div>
                    <div class="metric-subtitle">å¾—åˆ†: <span id="stabilityScore">100%</span></div>
                </div>
            </div>
        </div>
        
        <div class="analysis-section">
            <h3>è¯­éŸ³è¯†åˆ«ä¸éŸµå¾‹åˆ†æ</h3>
            
            <div class="asr-output" id="asrOutput">
                <div class="asr-current" id="currentText">ç­‰å¾…è¯­éŸ³è¾“å…¥...</div>
                <div class="asr-final" id="finalText"></div>
            </div>
            
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-title">åŸºé¢‘ (Hz)</div>
                    <div class="metric-value" id="pitchValue">0</div>
                    <div class="metric-subtitle">å˜åŒ–: <span id="pitchStd">Â±0</span></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">è¯­éŸ³èƒ½é‡</div>
                    <div class="metric-value" id="energyValue">0.00</div>
                    <div class="metric-subtitle">æ´»åŠ¨: <span id="activityLevel">é™é»˜</span></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">è¯­é€Ÿ (WPM)</div>
                    <div class="metric-value" id="speechRate">0</div>
                    <div class="metric-subtitle">è¿‡é›¶ç‡: <span id="zcrValue">0.0</span></div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">éŸ³è´¨ç‰¹å¾</div>
                    <div class="metric-value" id="voiceQuality">æ­£å¸¸</div>
                    <div class="metric-subtitle">é¢‘è°±é‡å¿ƒ: <span id="centroid">0</span> Hz</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="prosodyChart"></canvas>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button id="startBtn" class="btn btn-primary">å¼€å§‹åˆ†æ</button>
                <button id="stopBtn" class="btn btn-danger" disabled>åœæ­¢åˆ†æ</button>
                <button id="resetBtn" class="btn">é‡ç½®</button>
            </div>
            
            <div class="settings-panel">
                <div class="settings-row">
                    <label>å¯ç”¨é¢éƒ¨æ£€æµ‹</label>
                    <label class="switch">
                        <input type="checkbox" id="enableFace" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-row">
                    <label>å¯ç”¨éŸµå¾‹åˆ†æ</label>
                    <label class="switch">
                        <input type="checkbox" id="enableProsody" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="settings-row">
                    <label>æ˜¾ç¤ºå®æ—¶å›¾è¡¨</label>
                    <label class="switch">
                        <input type="checkbox" id="enableChart" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket;
        let mediaStream = null;
        let mediaRecorder = null;
        let isRecording = false;
        let prosodyChart = null;
        let frameCapture = null;
        
        // DOMå…ƒç´ 
        const videoPreview = document.getElementById('videoPreview');
        const faceOverlay = document.getElementById('faceOverlay');
        const statusIndicator = document.getElementById('statusIndicator');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeChart();
            setupEventListeners();
            requestMediaPermissions();
        });
        
        // Socket.IO è¿æ¥
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                updateStatus('connected', 'å·²è¿æ¥');
            });
            
            socket.on('disconnect', () => {
                console.log('WebSocketè¿æ¥æ–­å¼€');
                updateStatus('disconnected', 'è¿æ¥æ–­å¼€');
            });
            
            socket.on('session_started', (data) => {
                console.log('åˆ†æä¼šè¯å·²å¯åŠ¨:', data.message);
                updateStatus('processing', 'åˆ†æä¸­');
                startBtn.disabled = true;
                stopBtn.disabled = false;
            });
            
            socket.on('session_stopped', (data) => {
                console.log('åˆ†æä¼šè¯å·²åœæ­¢:', data.message);
                updateStatus('connected', 'å·²è¿æ¥');
                startBtn.disabled = false;
                stopBtn.disabled = true;
            });
            
            socket.on('analysis_result', (result) => {
                handleAnalysisResult(result);
            });
            
            socket.on('error', (error) => {
                console.error('æœåŠ¡å™¨é”™è¯¯:', error);
                alert('é”™è¯¯: ' + error.message);
            });
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initializeChart() {
            const ctx = document.getElementById('prosodyChart').getContext('2d');
            prosodyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'åŸºé¢‘ (Hz)',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'èƒ½é‡',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'åŸºé¢‘ (Hz)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'èƒ½é‡'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            startBtn.addEventListener('click', startAnalysis);
            stopBtn.addEventListener('click', stopAnalysis);
            resetBtn.addEventListener('click', resetAll);
            
            // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´canvas
            window.addEventListener('resize', resizeCanvas);
        }
        
        // è¯·æ±‚åª’ä½“æƒé™ï¼ˆæ”¹è¿›ç‰ˆæœ¬ï¼‰
        async function requestMediaPermissions() {
            try {
                // å…ˆæ£€æŸ¥HTTPS
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    showPermissionError('éœ€è¦HTTPSåè®®æ‰èƒ½è®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£\nè¯·ä½¿ç”¨ https:// è®¿é—®æ­¤é¡µé¢');
                    return;
                }
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showPermissionError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®\nè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆChromeã€Firefoxã€Edgeç­‰ï¼‰');
                    return;
                }
                
                // æ˜¾ç¤ºæƒé™ç”³è¯·æç¤º
                showPermissionDialog();
                
                // è¯·æ±‚æƒé™
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                videoPreview.srcObject = mediaStream;
                resizeCanvas();
                hidePermissionDialog();
                
                console.log('åª’ä½“æƒé™è·å–æˆåŠŸ');
                
            } catch (error) {
                console.error('åª’ä½“æƒé™è·å–å¤±è´¥:', error);
                handlePermissionError(error);
            }
        }
        
        // å¤„ç†æƒé™é”™è¯¯
        function handlePermissionError(error) {
            let message = '';
            let instructions = '';
            
            switch (error.name) {
                case 'NotAllowedError':
                    message = 'æ‘„åƒå¤´å’Œéº¦å…‹é£è®¿é—®è¢«æ‹’ç»';
                    instructions = `è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æˆæƒï¼š
                    
Chromeæµè§ˆå™¨ï¼š
1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„ ğŸ”’ æˆ– ğŸ“¹ å›¾æ ‡
2. é€‰æ‹©"å…è®¸"æ‘„åƒå¤´å’Œéº¦å…‹é£
3. åˆ·æ–°é¡µé¢é‡è¯•

æˆ–è€…ï¼š
1. è¿›å…¥ chrome://settings/content/camera
2. å°†æ­¤ç½‘ç«™æ·»åŠ åˆ°å…è®¸åˆ—è¡¨
3. å¯¹éº¦å…‹é£æ‰§è¡Œç›¸åŒæ“ä½œ`;
                    break;
                    
                case 'NotFoundError':
                    message = 'æœªæ‰¾åˆ°æ‘„åƒå¤´æˆ–éº¦å…‹é£è®¾å¤‡';
                    instructions = 'è¯·æ£€æŸ¥è®¾å¤‡è¿æ¥å¹¶é‡è¯•';
                    break;
                    
                case 'NotReadableError':
                    message = 'æ‘„åƒå¤´æˆ–éº¦å…‹é£è¢«å…¶ä»–åº”ç”¨å ç”¨';
                    instructions = 'è¯·å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨ç¨‹åº';
                    break;
                    
                default:
                    message = 'åª’ä½“è®¿é—®å¤±è´¥: ' + error.message;
                    instructions = 'è¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®å’Œè®¾å¤‡è¿æ¥';
            }
            
            showPermissionError(message + '\n\n' + instructions);
        }
        
        // æ˜¾ç¤ºæƒé™ç”³è¯·å¯¹è¯æ¡†
        function showPermissionDialog() {
            const dialog = document.createElement('div');
            dialog.id = 'permissionDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Segoe UI', sans-serif;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 400px;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“¹ğŸ¤</div>
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">éœ€è¦è®¿é—®æƒé™</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px; line-height: 1.6;">
                        æ­¤åº”ç”¨éœ€è¦è®¿é—®æ‚¨çš„æ‘„åƒå¤´å’Œéº¦å…‹é£<br>
                        è¿›è¡Œå®æ—¶å¤šæ¨¡æ€åˆ†æ
                    </p>
                    <div class="loading-spinner" style="
                        width: 30px;
                        height: 30px;
                        border: 3px solid #f3f3f3;
                        border-top: 3px solid #667eea;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto;
                    "></div>
                    <p style="color: #95a5a6; font-size: 14px; margin-top: 15px;">
                        è¯·åœ¨æµè§ˆå™¨å¼¹çª—ä¸­ç‚¹å‡»"å…è®¸"
                    </p>
                </div>
            `;
            
            document.body.appendChild(dialog);
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }
        
        // éšè—æƒé™å¯¹è¯æ¡†
        function hidePermissionDialog() {
            const dialog = document.getElementById('permissionDialog');
            if (dialog) {
                dialog.remove();
            }
        }
        
        // æ˜¾ç¤ºæƒé™é”™è¯¯
        function showPermissionError(message) {
            hidePermissionDialog();
            
            const dialog = document.createElement('div');
            dialog.id = 'errorDialog';
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Segoe UI', sans-serif;
            `;
            
            dialog.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                ">
                    <div style="font-size: 60px; margin-bottom: 20px;">âš ï¸</div>
                    <h3 style="margin-bottom: 15px; color: #e74c3c;">æƒé™è®¾ç½®</h3>
                    <pre style="
                        color: #2c3e50;
                        margin-bottom: 20px;
                        line-height: 1.6;
                        text-align: left;
                        background: #f8f9fa;
                        padding: 15px;
                        border-radius: 5px;
                        font-size: 13px;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                    ">${message}</pre>
                    <button onclick="this.parentElement.parentElement.remove(); requestMediaPermissions();" 
                            style="
                        background: #667eea;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">é‡è¯•</button>
                    <button onclick="this.parentElement.parentElement.remove();" 
                            style="
                        background: #95a5a6;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                    ">å…³é—­</button>
                </div>
            `;
            
            document.body.appendChild(dialog);
        }
        
        // å¼€å§‹åˆ†æ
        async function startAnalysis() {
            if (!mediaStream) {
                alert('è¯·å…ˆæˆæƒè®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£');
                return;
            }
            
            try {
                // å¯åŠ¨å½•éŸ³
                mediaRecorder = new MediaRecorder(mediaStream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        sendAudioData(event.data);
                    }
                };
                
                mediaRecorder.start(500); // æ¯500mså‘é€ä¸€æ¬¡éŸ³é¢‘æ•°æ®
                isRecording = true;
                
                // å¯åŠ¨è§†é¢‘å¸§æ•è·
                startFrameCapture();
                
                // é€šçŸ¥æœåŠ¡å™¨å¯åŠ¨ä¼šè¯
                socket.emit('start_session');
                
            } catch (error) {
                console.error('å¯åŠ¨åˆ†æå¤±è´¥:', error);
                alert('å¯åŠ¨åˆ†æå¤±è´¥: ' + error.message);
            }
        }
        
        // åœæ­¢åˆ†æ
        function stopAnalysis() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            if (frameCapture) {
                clearInterval(frameCapture);
                frameCapture = null;
            }
            
            // é€šçŸ¥æœåŠ¡å™¨åœæ­¢ä¼šè¯
            socket.emit('stop_session');
        }
        
        // é‡ç½®æ‰€æœ‰æ•°æ®
        function resetAll() {
            // æ¸…é™¤ASRè¾“å‡º
            document.getElementById('currentText').textContent = 'ç­‰å¾…è¯­éŸ³è¾“å…¥...';
            document.getElementById('finalText').textContent = '';
            
            // é‡ç½®æ‰€æœ‰æŒ‡æ ‡
            resetMetrics();
            
            // æ¸…é™¤å›¾è¡¨æ•°æ®
            if (prosodyChart) {
                prosodyChart.data.labels = [];
                prosodyChart.data.datasets.forEach(dataset => {
                    dataset.data = [];
                });
                prosodyChart.update();
            }
            
            // æ¸…é™¤é¢éƒ¨æ£€æµ‹æ¡†
            clearFaceOverlay();
        }
        
        // å‘é€éŸ³é¢‘æ•°æ®
        function sendAudioData(audioBlob) {
            const reader = new FileReader();
            reader.onload = () => {
                const arrayBuffer = reader.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                
                socket.emit('audio_data', {
                    audio: Array.from(uint8Array),
                    timestamp: Date.now()
                });
            };
            reader.readAsArrayBuffer(audioBlob);
        }
        
        // å¼€å§‹å¸§æ•è·
        function startFrameCapture() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            frameCapture = setInterval(() => {
                if (!document.getElementById('enableFace').checked) return;
                
                canvas.width = videoPreview.videoWidth;
                canvas.height = videoPreview.videoHeight;
                
                if (canvas.width > 0 && canvas.height > 0) {
                    ctx.drawImage(videoPreview, 0, 0);
                    const frameData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    socket.emit('video_frame', {
                        frame: frameData,
                        timestamp: Date.now()
                    });
                }
            }, 200); // æ¯200mså‘é€ä¸€å¸§
        }
        
        // å¤„ç†åˆ†æç»“æœ
        function handleAnalysisResult(result) {
            switch (result.type) {
                case 'asr':
                    updateASRDisplay(result.data);
                    break;
                case 'prosody':
                    updateProsodyDisplay(result.data);
                    break;
                case 'face':
                    updateFaceDisplay(result.data);
                    break;
            }
        }
        
        // æ›´æ–°ASRæ˜¾ç¤º
        function updateASRDisplay(data) {
            const currentText = document.getElementById('currentText');
            const finalText = document.getElementById('finalText');
            
            if (data.is_final) {
                // æœ€ç»ˆè¯†åˆ«ç»“æœ
                finalText.textContent += data.text + ' ';
                currentText.textContent = 'ç­‰å¾…è¯­éŸ³è¾“å…¥...';
            } else {
                // ä¸´æ—¶è¯†åˆ«ç»“æœ
                currentText.textContent = data.text;
            }
        }
        
        // æ›´æ–°éŸµå¾‹æ˜¾ç¤º
        function updateProsodyDisplay(data) {
            if (!document.getElementById('enableProsody').checked) return;
            
            // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
            document.getElementById('pitchValue').textContent = Math.round(data.pitch.mean);
            document.getElementById('pitchStd').textContent = 'Â±' + Math.round(data.pitch.std);
            document.getElementById('energyValue').textContent = data.energy.mean.toFixed(3);
            document.getElementById('activityLevel').textContent = data.activity_level;
            document.getElementById('speechRate').textContent = Math.round(data.speech_rate.estimated_rate);
            document.getElementById('zcrValue').textContent = data.speech_rate.zcr.toFixed(3);
            document.getElementById('voiceQuality').textContent = data.voice_quality.brightness;
            document.getElementById('centroid').textContent = Math.round(data.voice_quality.spectral_centroid);
            
            // æ›´æ–°å›¾è¡¨
            if (document.getElementById('enableChart').checked) {
                updateChart(data);
            }
        }
        
        // æ›´æ–°é¢éƒ¨æ˜¾ç¤º
        function updateFaceDisplay(data) {
            if (!document.getElementById('enableFace').checked) return;
            
            if (data.face_detected) {
                // æ›´æ–°é¢éƒ¨æŒ‡æ ‡
                const yaw = Math.round(data.head_pose.yaw);
                const pitch = Math.round(data.head_pose.pitch);
                document.getElementById('headPose').textContent = `${yaw}Â°, ${pitch}Â°`;
                
                document.getElementById('expression').textContent = data.expression.dominant_expression;
                document.getElementById('expressionConf').textContent = Math.round(data.expression.expression_confidence * 100) + '%';
                
                document.getElementById('eyeState').textContent = data.eyes.blink ? 'çœ¨çœ¼' : 'æ­£å¸¸';
                document.getElementById('earValue').textContent = data.eyes.ear.toFixed(2);
                
                document.getElementById('stability').textContent = data.stability.status;
                document.getElementById('stabilityScore').textContent = Math.round(data.stability.score * 100) + '%';
                
                // ç»˜åˆ¶é¢éƒ¨æ£€æµ‹æ¡†
                drawFaceBox(data.face_position);
            } else {
                // æ— é¢éƒ¨æ£€æµ‹
                resetFaceMetrics();
                clearFaceOverlay();
            }
        }
        
        // æ›´æ–°å›¾è¡¨
        function updateChart(data) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString();
            
            // é™åˆ¶æ•°æ®ç‚¹æ•°é‡
            const maxDataPoints = 20;
            
            if (prosodyChart.data.labels.length >= maxDataPoints) {
                prosodyChart.data.labels.shift();
                prosodyChart.data.datasets[0].data.shift();
                prosodyChart.data.datasets[1].data.shift();
            }
            
            prosodyChart.data.labels.push(timeLabel);
            prosodyChart.data.datasets[0].data.push(data.pitch.mean);
            prosodyChart.data.datasets[1].data.push(data.energy.mean * 1000); // æ”¾å¤§æ˜¾ç¤º
            
            prosodyChart.update('none');
        }
        
        // ç»˜åˆ¶é¢éƒ¨æ£€æµ‹æ¡†
        function drawFaceBox(facePos) {
            const canvas = faceOverlay;
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (facePos.size > 0) {
                const centerX = facePos.center_x * canvas.width;
                const centerY = facePos.center_y * canvas.height;
                const boxSize = Math.sqrt(facePos.size) * Math.min(canvas.width, canvas.height);
                
                const x = centerX - boxSize / 2;
                const y = centerY - boxSize / 2;
                
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, boxSize, boxSize);
                
                // ç»˜åˆ¶ä¸­å¿ƒç‚¹
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
        
        // æ¸…é™¤é¢éƒ¨è¦†ç›–å±‚
        function clearFaceOverlay() {
            const canvas = faceOverlay;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // è°ƒæ•´canvaså¤§å°
        function resizeCanvas() {
            const canvas = faceOverlay;
            const video = videoPreview;
            
            if (video.videoWidth && video.videoHeight) {
                canvas.width = video.offsetWidth;
                canvas.height = video.offsetHeight;
            }
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(status, text) {
            statusIndicator.className = `status-indicator status-${status}`;
            statusIndicator.textContent = text;
        }
        
        // é‡ç½®æŒ‡æ ‡
        function resetMetrics() {
            // éŸµå¾‹æŒ‡æ ‡
            document.getElementById('pitchValue').textContent = '0';
            document.getElementById('pitchStd').textContent = 'Â±0';
            document.getElementById('energyValue').textContent = '0.00';
            document.getElementById('activityLevel').textContent = 'é™é»˜';
            document.getElementById('speechRate').textContent = '0';
            document.getElementById('zcrValue').textContent = '0.0';
            document.getElementById('voiceQuality').textContent = 'æ­£å¸¸';
            document.getElementById('centroid').textContent = '0';
            
            resetFaceMetrics();
        }
        
        // é‡ç½®é¢éƒ¨æŒ‡æ ‡
        function resetFaceMetrics() {
            document.getElementById('headPose').textContent = '0Â°, 0Â°';
            document.getElementById('expression').textContent = 'ä¸­æ€§';
            document.getElementById('expressionConf').textContent = '0%';
            document.getElementById('eyeState').textContent = 'æ­£å¸¸';
            document.getElementById('earValue').textContent = '0.30';
            document.getElementById('stability').textContent = 'ç¨³å®š';
            document.getElementById('stabilityScore').textContent = '100%';
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>